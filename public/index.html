<!DOCTYPE html>
<html>
<head>
	<title>Quản lý công việc</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	
	<!-------- Firebase and login checking go here ---------->
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-app.js"></script>

	<!-- Add SDKs for Firebase products that you want to use
	     https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-analytics.js"></script>

	<!-- firebase authentication -->
	<script src="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth__vi.js"></script>
	<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth.css" />

	<script src="lib/logScript.js"></script>
	<script src="lib/firebaseScript.js"></script>
	<!-------- Fonts go here ---------->
	<!--Import Google Icon Font-->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!-- Awesome Font -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-------------------------------------------------->
	<!-------- CSS goes here ---------->
	<!-- Compiled and minified MaterializeCSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
	<!-- Firebase CSS -->
	<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth.css" />
	<!-- W3 CSS -->
	<!-- <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">  -->
	<!-- <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-green.css"> -->

  <link rel="stylesheet" type="text/css" href="lib/w3.css">
  <link rel="stylesheet" type="text/css" href="lib/w3-theme-green.css">
  <link rel="stylesheet" type="text/css" href="lib/lds-spinner.css">
  <link rel="stylesheet" type="text/css" href="lib/custom.css">
	
	<style type="text/css" description="specific-custom">

		@media screen and (max-width: 400px) {.show400px {display: none;}}
		@media screen and (min-width: 1000px) {.show400px {max-width: 100px}}

		@media screen and (max-width: 1000px) {.txLarge{font-size: 18px}.txSmall{font-size: 11px}.txxLarge{font-size: 22px}}
		@media screen and (max-width: 800px) {.txLarge{font-size: 15px}.txSmall{font-size: 10px}.txxLarge{font-size: 20px}}
		@media screen and (max-width: 700px) {.txLarge{font-size: 12px}.txSmall{font-size: 9px}.txxLarge{font-size: 20px}}
		@media screen and (max-width: 600px) {.txLarge{font-size: 18px}.txSmall{font-size: 12px}.txxLarge{font-size: 18px}}
		@media screen and (max-width: 440px) {.txLarge{font-size: 15px}.txSmall{font-size: 10px}.txxLarge{font-size: 16px}}
		@media screen and (max-width: 350px) {.txLarge{font-size: 12px}.txSmall{font-size: 9px}}
		@media screen and (max-width: 280px) {.txxLarge{font-size: 14px}}

		input.searchDark{color: #fff;}

		.sthoanthanh{background-color: #109618; color: #fff; opacity: 0.75}
		.stChoduyetHoanthanh{background-color: #02a99a; color: #fff; opacity: 0.9}
		.stChoduyetTamdung{background-color: #f5c043; color: #000; opacity: 0.9}
		.stTuchoiYeucau{background-color: #e91b86; color: #fff; opacity: 0.75}
		.stHoanthanh{background-color: #3366cc; color: #fff; opacity: 0.75}
		.stQuahan{background-color: #dc3912; color: #fff; opacity: 0.75}
		.stKetthuc{background-color: #855e58; color: #fff; opacity: 0.75}
		.stHethan{background-color: #dc3912; color: #fff; opacity: 0.75}
		.stTamdung{background-color: #ff9900; color: #000; opacity: 0.75}
		.stMoi{background-color: #0099c6; color: #fff; opacity: 0.75}
		.stBatdau{background-color: #6e8a42; color: #fff; opacity: 0.75}
	
		#idSidebar{background-color: #252a2d; color: #797a7b; width: 25%}
		#idSidebarSearch{background-color: #202527; color: #fff; width: 100%}
		#idSidebarUserPanel{background-color: #202527; width: 100%}
		@media screen and (max-width: 1267px) {#idSidebar {width: 30%}}
		@media screen and (max-width: 1065px) {#idSidebar {width: 40%}}
		@media screen and (max-width: 800px) {#idSidebar {width: 50%}}
		@media screen and (max-width: 636px) {#idSidebar {width: 70%}}
		@media screen and (max-width: 431px) {#idSidebar {width: 80%}}
		#idSolieuTable tbody tr td{padding: 2px 2px 2px 16px;}
		p{margin: 2px 0px}
		hr{margin: 5px}
		label{color: black}
	</style>
	
</head>
<body class="fullh unseen" onresize="logF(onScreenResize)">
	
	<!-- Overlay -->
  <div class="w3-overlay w3-display-container ptr" onclick="logF(overlayHiddenOnly)" id="idOverlay">
  	<div class="lds-spinner w3-display-middle" id="idOverlaySpinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
  	<div class="w3-card-4 w3-display-middle w3-white hidden" id="idOverlayPanel" style="width: 350px; height: 400px;z-index: 2">
		<div class="w3-bar"><h3 class="w3-bar-item">Cài đặt</h3><h5 class="w3-right w3-bar-item" onclick="logF(overlayHiddenAll)">&times;</h5></div>
		<div class="w3-bar w3-row"><p class="w3-bar-item w3-col s6">Fast Mode</p>
		<div class="switch w3-col s6 w3-bar-item"> <label> Tắt <input type="checkbox" onchange="onCboxChange({elm:this})"> <span class="lever"></span> Bật </label> </div><!-- Switch -->
		</div>
  	</div>
  </div>

  <script description="Overlay">
  	var obOverlay = {},elmObNames=['e','spinner','panel'];initOverlay=()=>{initElm(obOverlay,elmObNames,['idOverlay','idOverlaySpinner','idOverlayPanel']);}
  	overlayCtr=(val,vIdx)=>obOverlay[elmObNames[vIdx]+'s'].display=(val==1)?'block':'none';
  	overlayShowSpinner=()=>{[1,1,0].forEach(overlayCtr);} 
  	overlayShowPanel=()=>{[1,0,1].forEach(overlayCtr)}
  	overlayHiddenAll=()=>{[0,0,0].forEach(overlayCtr);}
  	overlayHiddenOnly=(e)=>{e=e||window.event;var target=e.target||e.srcElement; logE(target);if(target.id!='idOverlay') return false; else overlayHiddenAll();}

  	onCboxChange=(p)=>{mainData.settings.fastMode=(p.elm.checked);elmLoop(document,'classFastMode',e=>{e.value=p.elm.checked?mainData.user.hoten:'';e.disabled=p.elm.checked;});}
  </script>

	<!-- Sidebar -->
	<div class="w3-sidebar w3-bar-block w3-animate-left hidden w3-display-container " id="idSidebar">
		<div class="w3-xlarge w3-container w3-row" id="idSidebarSearch">
			<div class="w3-col" style="width:25px"><i class="fa fa-search w3-large"></i></div>
			<div class="w3-rest"><input type="text" onkeyup="logF(sidebarSearch,{elm:this})" placeholder="Tìm dự án - phòng ban" class="w3-input w3-border-0 searchDark"></div>
		</div>
		<div class="overYAuto" id="idSidebarContent" >
			<div class="w3-bar-item sidebarGroup txBold" style="padding: 5px 8px;color: #656768" onclick="logF(sidebarGroupToggle,{g:0})" >
				<div class="w3-col" style="width:15px;"><i class="fa fa-angle-right w3-large"></i></div>Test Group
			</div>
			<div class="hidden">
				<b class="w3-bar-item w3-hover-theme" style="margin: 2px 0px;padding: 4px 10px;padding-left: 40px;color: #929495" onclick="logF(sidebarItemClick,{g:0,i:0})">TestItem1</b>
				<b class="w3-bar-item w3-hover-theme" style="margin: 2px 0px;padding: 4px 10px;padding-left: 40px;color: #929495" onclick="logF(sidebarItemClick,{g:0,i:1})">TestItem2</b>
				<b class="w3-bar-item w3-hover-theme" style="margin: 2px 0px;padding: 4px 10px;padding-left: 40px;color: #929495" onclick="logF(sidebarItemClick,{g:0,i:2})">TestItem3</b>
			</div>
		</div>

		<!-- User Avatar And Information -->
		<div class="w3-display-bottomleft  w3-text-white w3-row" id="idSidebarUserPanel">
				<div class="w3-col s12 divider"></div>
				<img id="idUserImg" class="show400px w3-col s3 w3-circle pad10p">
	      <div class="w3-col s9 w3-container txOnImg txBold pad10p" >
	      	<a id="idUserName">Nguyễn Mạnh Cường</a><br>
	      	<a id="idUserSubName">Nguyễn Mạnh Cường</a><br>
					<a id="idSignedInEmail" class="w3-small">Cuongbk56@gmail.com</a><br>
      		<a id="idDonvi" class="w3-small subTx">Đội Thiết bị Thông tin Dẫn đường</a><br>
				</div>  
		</div>
	</div>
	<script description="overlaySidebar">
	var obSidebar = {data:[
		{n:'Thông dụng',i:['Công việc của tôi','Công việc đơn vị','Công việc trung tâm'],c:['mine','mygroup','NAOC']},
		{n:'Đơn vị',i:['Thiết bị Thông tin Dẫn đường','Cơ điện đèn','Bảo trì sân đường','Môi trường khu bay','Văn phòng','Quản lý CHK Nà Sản'],
			c:['TBTTDD','CDD','BTSD','MTKB','VPKB','CHKNS']},
		],active:{g:0,i:0}};

	const domKList=['idSidebar','idSidebarSearch','idSidebarUserPanel','idSidebarContent','idUserName','idUserSubName',
									'idSignedInEmail','idDonvi','idUserImg'];
	const objKList=['e','search','userEl','c','userName','userSubName','userSignedInEmail','userDonvi','userImg'];
	initSideBar=()=>{
		initElm(obSidebar,objKList,domKList);obSidebar.initData=obSidebar.data;
		obSidebar.gr=obSidebar.e.getElementsByClassName('sidebarGroup');sidebarPopulateContent();
		setUserInf();sidebarItemClick(obSidebar.active);
	};

	const userObjKlist=['userName','userSubName','userSignedInEmail','userDonvi'];
	const userDataKlist=['hoten','tenkhac','email','donvi'];
	setUserInf=()=>{userObjKlist.map((k,ind)=>{obSidebar[k].innerHTML=mainData.user[userDataKlist[ind]]});setUserImg();}
	setUserImg=()=>{obSidebar.userImg.src=(mainData.user.img==undefined||mainData.user.img=='')?'https://www.w3schools.com/w3css/img_avatar1.png':mainData.user.img};

	getSidebarSize=()=>{var vw=obView.vw();return vw>1267?'25%':(vw<431?'80%':vw<636?'70%':vw<800?'50%':vw<1065?'40%':'30%');}
	setSidebarcontentHeight=()=>{obSidebar.cs.maxHeight=(obView.vh()-(obSidebar.search.offsetHeight+obSidebar.userEl.offsetHeight))+'px'};

	const NoLegend=1;
    sidebarOpen=()=>{obMain.es.marginLeft=getSidebarSize();obSidebar.es.display="block";setSidebarcontentHeight();mainElmsHideOnSmall();obSidebar.state=1;drawChart();}
    sidebarClose=()=>{obMain.es.marginLeft = "0%";obSidebar.es.display="none";mainElmsUnhideOnSmall();obSidebar.state=0;drawChart();}
    sidebarToggle=()=>{obSidebar.state==1?sidebarClose():sidebarOpen();}
    sidebarResize=()=>{obSidebar.state==1?sidebarOpen():null;}

    getSbArrBtn=(gIndex)=>{return obSidebar.gr[gIndex].children[0].children[0].classList;}
    getSbGroupElm=(gIndex)=>{return obSidebar.gr[gIndex].nextElementSibling}
    getSbItem=(gIndex,iIndex)=>{return getSbGroupElm(gIndex).children[iIndex]}

    const aDown='fa-angle-down', aRight='fa-angle-right';
    sidebarGroupOpen=(p)=>{getSbGroupElm(p.g).style.display='block';var arrCl=getSbArrBtn(p.g);arrCl.remove(aRight);arrCl.add(aDown);}
    sidebarGroupClose=(p)=>{getSbGroupElm(p.g).style.display='none';var arrCl=getSbArrBtn(p.g);arrCl.remove(aDown);arrCl.add(aRight);}
    sidebarGroupToggle=(p)=>{(getSbGroupElm(p.g).style.display=='block')?sidebarGroupClose(p):sidebarGroupOpen(p);}

    const itSelectedCl='w3-panel w3-leftbar w3-border-theme w3-grey w3-text-white';
    const itNormalCl='w3-hover-theme';
    isParamEqual=(p1,p2)=>(p1.g==p2.g&&p1.i==p2.i);

    setSidebarItemClicked=(param)=>{
    	var selectedElmCl = (!obSidebar.active||isParamEqual(obSidebar.active,param))?null:getSbItem(obSidebar.active.g,obSidebar.active.i).classList;
    	obSidebar.active = param;sidebarGroupOpen(param);var newElmCl=getSbItem(param.g,param.i).classList;
    	itSelectedCl.split(' ').map((cl)=>{newElmCl.add(cl);selectedElmCl?selectedElmCl.remove(cl):''});
    	itNormalCl.split(' ').map((cl)=>{newElmCl.remove(cl);selectedElmCl?selectedElmCl.add(cl):''});
    }

    sidebarItemClick=(param)=>{setSidebarItemClicked(param);logF(mainPopulateContent,param);logF(initAutoStaffList);};

    sidebarSearch=(p)=>{
    	var searchVal=p.elm.value.toUpperCase();
    	if(searchVal.length==0) {logF(restoreSidebarData);sidebarPopulateContent();setSidebarItemClicked(obSidebar.active);}
    	else{obSidebar.data=obSidebar.origin.map(gr=>{var out={n:gr.n,i:[],c:[]};
    		gr.i.map((item,idx)=>{if(item.toUpperCase().search(searchVal)>-1){out.i.push(item);out.c.push(gr.c[idx])}}); return out;});sidebarPopulateContent();
    		obSidebar.data.forEach((gr,grIdx)=>{if(gr.i.length>0) sidebarGroupOpen({g:grIdx})});
    	}
    }
    sidebarPopulateContent=()=>{
    	var gName='';
    	obSidebar.data.map((group,gIndex)=>{
    		gName+=`<div class="w3-bar-item sidebarGroup txBold" style="padding: 5px 8px;color:#656768" onclick="logF(sidebarGroupToggle,{g:${gIndex}})" ><div class="w3-col" style="width:15px"><i class="fa fa-angle-right w3-large"></i></div> ${group.n}</div><div class="${group.show?'':'hidden'}">`;
    		group.i.map((item,iIndex)=>{
    			gName+=`<b class="w3-bar-item w3-container w3-hover-theme idSidebarItem" style="margin: 2px 0px;padding:4px 10px;padding-left: 40px;;color: #929495" onclick="logF(sidebarItemClick,{g:${gIndex},i:${iIndex}})">${item}</b>`;
    		});
    		gName+='</div>';
    	});
    	obSidebar.c.innerHTML=gName;
    }
	</script>

	<!-- Float Action Button View, Update (show Modal on Desktop/Container On Mobile) -->
	<div class="fixed-action-btn" id="floatActionBt">
    <a class="btn-floating btn-large waves-effect waves-light red">
      <i class="large material-icons" id="idFAB">remove_red_eye</i>
    </a>
    <ul>
      <li><a class="btn-floating gray"><i class="material-icons" onclick="setFabMode(goToTop)">publish</i></a></li>
      <li><a class="btn-floating blue"><i class="material-icons" onclick="setFabMode(report)">assignment</i></a></li>
      <li><a class="btn-floating green"><i class="material-icons" onclick="setFabMode('taskCompleted','done','green')">done</i></a></li>
      <li><a class="btn-floating red"><i class="material-icons" onclick="setFabMode('deletetask','delete','red')">delete</i></a></li>
      <li><a class="btn-floating cyan"><i class="material-icons" onclick="setFabMode('editTask','edit','cyan')">edit</i></a></li>
      <li><a class="btn-floating red"><i class="material-icons" onclick="setFabMode('viewOnly','remove_red_eye','red')">remove_red_eye</i></a></li>
    </ul>
  </div>
  <script description="floatActionButton">
  	var obFab = {};
  	initFab=()=>{obFab.i=M.FloatingActionButton.init(document.querySelectorAll('.fixed-action-btn'), {hoverEnabled:false});
  		initElm(obFab,['e'],['idFAB']);
  	}
  	setFabMode=(mode,mIcon,color)=>{if(color){obFab.m = mode.name;bgFAB(color);obFab.e.innerHTML=mIcon;}mode();}
  	bgFAB=(color)=>{['red','green','blue','cyan'].map((cItem)=>{if(cItem!=color)obFab.ec.remove(cItem);});obFab.ec.add(color);}
  </script>

  <div id="idMain">
		<!-- Navigation bar -->
	  <div class="w3-row w3-top">
	    <div class="w3-row w3-theme txxLarge w3-col s12">
	      <div class="w3-bar w3-col s12 w3-text-white">
	        <a class="w3-bar-item w3-button w3-hover-theme" onclick="logF(onMenuClick)"><i class="fa fa-bars" id="idMenu"></i></a>
	        <span class="w3-bar-item">Quản Lý Công việc</span>  
	        <a class="w3-right txSmall pad10p" href="" onclick="onSignOut();return false;">Đăng xuất</a>
	        <a class="w3-bar-item w3-button w3-hover-theme w3-right" onclick="logF(overlayShowPanel);"><i class="fa fa-cog"></i></a>
	      </div>
	    </div>
		</div>
		<script description="Navigation">
			var obMenuc=document.getElementById('idMenu').classList;
			onMenuClick=()=>{logF(sidebarToggle);obMenuc.toggle('fa-bars');obMenuc.toggle('fa-times');}
		</script>

		<!-- Main content -->
		<div id="idMainContainer" class="w3-row">
			<div class="w3-xxlarge w3-col s12 w3-hide-small" id="dummyNavbar">.</div>
			<div class="w3-xlarge w3-col s12 w3-hide-large w3-hide-medium" id="dummyNavbar">.</div>

			<div id="idMainTieude" class="w3-col s12 w3-container"><h3>Title: Công việc của tôi</h3></div>

			<div id="idSubSidebar" class="w3-right w3-col s12 m3 w3-container bot12p">
				<div class="w3-card-2 w3-container " id="idMainSearch">
					<div class="w3-col s12 w3-row w3-large">
						<div class="w3-col" style="width:30px;margin-top: 10px"><i class="fa fa-search"></i></div>
						<div class="w3-rest"><input type="text"  placeholder="Lọc danh sách công việc.." onkeyup="logF(mainSearch,{elm:this})" onfocus="logF(focusMainSearch)" class="w3-input w3-border-0"></div>
					</div>
				</div>
				<div class="w3-card-2 w3-container mT10p" id="idMainSolieu" >
					<div class="w3-col s6 m12 w3-row bot10p" onclick="logF(mainSolieuToggleOnSmall);">
						<h4>Tiến độ</h4>
						<div class="pad10p w3-col s12 hideOnSearchFocus">
							<div class="w3-cell-row">
								<div class="w3-cell w3-cell-middle w3-col s6 pad10p txCenter"><b class="txLarge" id="idSolieuNo">--</b><br><b class="txSmall">Công việc</b></div>
								<div class="w3-cell w3-cell-middle w3-col s6 pad10p txCenter"><b class="txLarge" id="idSolieuPercent">--.-%</b><br><b class="txSmall">Đã hoàn thành</b></div>
							</div>
							<div class="w3-light-grey w3-round-xlarge progressHeight"><div class="w3-container w3-theme w3-round-xlarge progressHeight" style="width:25%;" id="idSolieuBar"></div></div>
						</div>
					</div>
					<div class="w3-col s6 m12 " onclick="logF(mainSolieuToggleOnSmall);">
						<h4>Thống kê</h4>
						<div class="jam hideOnSearchFocus">
							<table class="w3-table w3-bordered " id="idSolieuTable">
								<tbody>
									<tr><td class="txSmall"><b>Được giao: <b></td><td><b class="solieuTableData txSmall">--<b></td></tr>
									<tr><td class="txSmall">Đang thực hiện: </td><td class="solieuTableData txSmall">--</td></tr>
									<tr><td class="txSmall">Tạm dừng: </td><td class="solieuTableData txSmall">--</td></tr>
									<tr><td class="txSmall">Hoàn thành: </td><td class="solieuTableData txSmall">--</td></tr>
									<tr><td class="txSmall">Quá hạn: </td><td class="solieuTableData txSmall">--</td></tr>
									<tr><td class="txSmall">Đang chờ duyệt hoàn thành: </td><td class="solieuTableData txSmall">--</td></tr>
									<tr><td class="txSmall">Đang chờ duyệt tạm dừng: </td><td class="solieuTableData txSmall">--</td></tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="w3-col s12 hideOnSearchFocus">
						<div id="piechart" style="width: 100%;"></div>
					</div>
				</div>
			</div>
			<script description="chartControl">
				var chartApiReady = false, chart=null;
				var chartData=[['Tình trạng', 'Số lượng'],['Đang thực hiện', 0],['Tạm dừng', 0],['Hoàn thành', 0],['Quá hạn', 0],['Chờ duyệt hoàn thành', 0],['Chờ duyệt tạm dừng', 0]];

				// Draw the chart and set the chart values
				drawChart=(noLegend,inData)=>{ // bug: xong data thi sua chart voi nolegend
					if(noLegend==undefined) noLegend=obSidebar.state;
					if(!chartApiReady){console.warn('chartApi is not ready');return;} if(inData) inData.map((val,idx)=>{if(idx>0)chartData[idx][1]=val});

					var data = google.visualization.arrayToDataTable(chartData);
					var options = {chartArea:{width:'100%',height:'75%'},height:150,colors:['#109618','#ff9900','#3366cc','#dc3912','#02a99a','#f5c043'],legend:(noLegend==1)?'none':{textStyle:{fontSize:10}}};
					(chart = chart?chart:new google.visualization.PieChart(document.getElementById('piechart'))).draw(data, options);
				}

				var obSolieu={};
				initSolieu=()=>{initElm(obSolieu,['no','percent','bar','table'],['idSolieuNo','idSolieuPercent','idSolieuBar','idSolieuTable']);}
				obSolieu.setStats=function(dataTbl){
					var pcent=((dataTbl[0]!=0)?(dataTbl[3]/dataTbl[0]*100).toFixed(1):'0.0')+'%';
					this.no.innerHTML=dataTbl[3];this.percent.innerHTML=pcent;this.bars.width=pcent;
					Array.from(this.table.getElementsByClassName('solieuTableData')).map((el,elIdx)=>{el.innerHTML=dataTbl[elIdx]});
					drawChart(0,dataTbl);
				}
				statisticLoading=(cvList)=>{
					var idx={danghoanthanh:1,tamdung:2,hoanthanh:3,quahan:4,choduyetHoanthanh:5,choduyetTamdung:6}, countCv=0;
					var statisticalTbl = cvList.reduce((out,item)=>{
						if(dataFilter(item,mainData.filter)==false) return out;
						out[0]++;

						if(item.tinhtrang.search(/thực hiện/gi)>-1) out[idx.danghoanthanh]++;
						var testHoanthanh = item.tinhtrang.search(/hoàn thành/gi)>-1, testTamdung = item.tinhtrang.search(/tạm dừng/gi)>-1;
						if(testHoanthanh) out[idx.hoanthanh]++; if(testTamdung) out[idx.tamdung]++;

						var testChoDuyet = item.tinhtrang.search(/chờ duyệt/gi)>-1, testTuchoi = item.tinhtrang.search(/Từ chối yêu cầu/gi)>-1;
						if(testHoanthanh&&testChoDuyet) {out[idx.hoanthanh]--;out[idx.choduyetHoanthanh]++;}
						if(testTamdung&&testChoDuyet) {out[idx.tamdung]--;out[idx.choduyetTamdung]++;}
						if(testHoanthanh&&testTuchoi) out[idx.hoanthanh]--;
						if(testTamdung&&testTuchoi) out[idx.tamdung]--;
						var fDue=item.giaoviec.thoihan.full.split('/'), deltaTime=new Date()-new Date(fDue[2],fDue[1]-1,parseInt(fDue[0])+1);
						if(deltaTime>0) out[idx.quahan]++;
						return out;
					},[countCv,0,0,0,0,0,0]);
					obSolieu.setStats(statisticalTbl);
				}
				
			</script>

			<div id="idMainDulieu" class="w3-col s12 m9 bot12p w3-row"  style="padding-left: 8px; padding-right: 8px">
				<ul class="w3-col s12 collapsible" id="idMainList" style="margin: 0px">
					<li id="idAddDulieuList" class="hidden">
						<div class="pLR15px collapsible-header" >
							<p><div class="mplus"></div><b class="pR4px w3-text-theme"> Thêm Công việc mới </b></p>
						</div>
						<div class="pLR15px collapsible-body m0px">
							<form autocomplete="off" class="w3-row" name="idGiaoviecForm" id="idGiaoviecForm">
								<div class="w3-col s12 m4  w3-container">
									<label for="idNguoigiao">Người giao</label><input type="text" name="idNguoigiao" class="classNguoigiao classFastMode">
								</div>
								<div class="w3-col s12 m4  w3-container">
									<label for="idPhutrach">Người phụ trách</label><input type="text" name="idPhutrach" class="classPhutrach">
								</div>
								<div class="w3-col s12 m4  w3-container">
									<label for="idNguoinhan">Người thực hiện</label><input type="text" name="idNguoinhan" class="classNguoinhan">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idDonvinhan" id="idDonvinhanLabel">Đơn vị thực hiện</label>
									<input type="text" name="idDonvinhan" class="classDonvinhan">
								</div>
								<div class="w3-col s8 w3-container">
									<label for="idDuan">Thuộc dự án</label><input type="text" name="idDuan" class="classDuan">
								</div>
								<div class="w3-col s8 m4 w3-container">
									<label for="idNgayYeucau">Ngày yêu cầu hoàn thành</label><input type="date" name="idNgayYeucau">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idTencongviec">Tên công việc</label><input type="text" name="idTencongviec">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idNoidungchitiet">Nội dung chi tiết</label><textarea class="materialize-textarea" id="idNoidungchitiet"></textarea>
								</div>
								<div class="w3-cell-row">
									<div class="w3-cell w3-center" ><button class="w3-button w3-blue w97" type="button" onclick="logF(taskContentGetUI,{elm:this,index:-1})">Giao việc</button></div>
								</div>
							</form>
						</div>
					</li>
					<!-- CongviecItem--see CongviecItem for more detail -->
					
				</ul>

			</div>
			<script description="listControl">
				var obDulieu={};
				initDulieuUI=()=>{initElm(obDulieu,['e','list','plus'],['idMainDulieu','idMainList','idAddDulieuList']);}

				updateListDulieu=()=>{emptyListDulieu();addListDulieu(mainData.congviecList)}
				emptyListDulieu=()=>Array.from(obDulieu.list.getElementsByClassName('classMainListItem')).forEach((item)=>{item.remove()});
				addListDulieu=(items)=>{items.forEach((item,itemIdx)=>dataFilter(item,mainData.filter)?addItemDulieu(item,itemIdx):'');}
				addItemDulieu=(item,index)=>{
					var elmTags=tagAnalysis(item);

					var hoanthanhPheduyetOkCode = item.hoanthanh.pheduyet.ok, tamdungPheduyetOkCode = item.tamdung.pheduyet.ok;

					var thuchienOk=(item.thuchien.ok.length>0&&item.thuchien.ok>0);
					var hoanthanhOk=item.hoanthanh.ok.length>0,hoanthanhPheduyetOk=(item.hoanthanh.pheduyet.ok.length>0&&hoanthanhPheduyetOkCode>0);
					var tamdungOk=item.tamdung.ok.length>0,tamdungPheduyetOk=(item.tamdung.pheduyet.ok.length>0&&tamdungPheduyetOkCode>0);

					var elmExtend=hoanthanhOk>0?(
						`<div class="w3-col s12 m6"><p class="pLR7px"></p><h4><b>Hoàn thành</b></h4><p><b>Người thực hiện: </b>${item.hoanthanh.nguoihoanthanh.hoten}</p>
						<p><b>Ngày hoàn thành: </b>${item.hoanthanh.ngayhoanthanh.full}</p>
						<p><b>Kết quả thực hiện: </b></p><p>${item.hoanthanh.ketqua.split('\n').join('</p><p>')}</p></div>`
					+((hoanthanhPheduyetOk>0)?
						`<div class="w3-col s12 m6"><p class="pLR7px"></p><h4><b>Phê duyệt Hoàn thành:</b></h4><p>
						<p><b>Người phê duyệt: </b>${item.hoanthanh.pheduyet.nguoipheduyet.hoten}</p>
						<p><b>Ngày phê duyệt: </b>${item.hoanthanh.pheduyet.ngaypheduyet.full}</p>
						<p><b>Nội dung: </b> Kết quả ${hoanthanhPheduyetOkCode==2?'không':'đã'} được phê duyệt </p>
						<p>${item.hoanthanh.pheduyet.noidung.split('\n').join('</p><p>')}</p></div>`:'')):'';
					elmExtend+=tamdungOk?(
						`<div class="w3-col s12 m6"><p class="pLR7px"></p><h4><b>Tạm dừng</b></h4><p><b>Người xin tạm dừng: </b>${item.tamdung.nguoixintamdung.hoten}</p>
						<p><b>Ngày xin tạm dừng: </b>${item.tamdung.ngayxintamdung.full}</p>
						<p><b>Lý do tạm dừng: </b></p><p>${item.tamdung.lydo.split('\n').join('</p><p>')}</p></div>`
					+((tamdungPheduyetOk)?
						`<div class="w3-col s12 m6"><p class="pLR7px"></p><h4><b>Phê duyệt Tạm dừng:</b></h4><p>
						<p><b>Người phê duyệt: </b>${item.tamdung.pheduyet.nguoipheduyet.hoten}</p>
						<p><b>Ngày phê duyệt: </b>${item.tamdung.pheduyet.ngaypheduyet.full}</p>
						<p><b>Nội dung: </b> Yêu cầu tạm dừng ${tamdungPheduyetOkCode==2?'không':'đã'} được phê duyệt </p>
						<p>${item.tamdung.pheduyet.noidung.split('\n').join('</p><p>')}</p></div>`:'')):'';

					var hoanthanhBtns=
					`<div class="nhanvienCtrl hidden"><div class="w3-cell-row">
						<div class="w3-cell w3-center" ><button class="w3-button w3-blue w95" onclick="logF(itemStateSelected,{elm:this,state:2});">Hoàn thành</button></div>
						<div class="w3-cell w3-center"><button class="w3-button w3-orange w95" onclick="logF(itemStateSelected,{elm:this,state:3});">Tạm dừng</button></div>
					</div>
					<div class="hidden w3-container mT10p">
						<form class="w3-row hidden hoanthanhForm" autocomplete="off">
							<div class="w3-col s8"><label>Người hoàn thành</label><input class="inputTag hidden" id="inputTagNguoihoanthanh${index}" value='${JSON.stringify(item.hoanthanh.nguoihoanthanh)}'>
							<input type="text" name="idNguoihoanthanh${index}" class="classNguoihoanthanh classFastMode"></div>
							<div class="w3-col s11"><label>Kết quả thực hiện</label><textarea class="materialize-textarea" name="idKetquahoanthanh${index}"></textarea></div>
							<div class="w3-cell-row">
							<div class="w3-cell w3-center"><button class="w3-button w3-theme pheduyet" onclick="logF(dataSubmitTask,{elm:this,index:${index},state:0})" type="button">Gửi đi phê duyệt</button></div></div>
						</form>
						<form class="w3-row hidden tamdungForm" autocomplete="off">
							<div class="w3-col s8"><label>Người xin tạm dừng</label><input class="inputTag hidden" id="inputTagNguoixintamdung${index}" value='${JSON.stringify(item.tamdung.nguoixintamdung)}'>
							<input type="text" name="idNguoixintamdung${index}" class="classNguoixintamdung classFastMode"></div>
							<div class="w3-col s11"><label>Lý do tạm dừng</label><textarea class="materialize-textarea" name="idLydotamdung${index}"></textarea></div>
							<div class="w3-cell-row">
							<div class="w3-cell w3-center"><button class="w3-button w3-theme pheduyet" onclick="logF(dataSubmitTask,{elm:this,index:${index},state:1})" type="button">Gửi đi phê duyệt</button></div></div>
						</form>
					</div></div>`;
					var source=hoanthanhOk?'hoanthanh':'tamdung', btnStateColor=hoanthanhOk?'w3-blue':'w3-orange', stateTx=hoanthanhOk?'hoàn thành':'tạm dừng';
					var pheduyetBtns=
					`<div class="pheduyetCtrl hidden"><div class="w3-cell-row">
						<div class="w3-cell w3-center" ><button class="w3-button w3-gray w95" onclick="logF(itemStateSelected,{elm:this,state:2});">Không duyệt ${stateTx}</button></div>
						<div class="w3-cell w3-center"><button class="w3-button ${btnStateColor} w95" onclick="logF(itemStateSelected,{elm:this,state:3});">Phê Duyệt ${stateTx}</button></div>
					</div>
					<div class="hidden w3-container mT10p">
						<form class="w3-row hidden" autocomplete="off">
							<div class="w3-col s8"><label>Người phê duyệt</label><input class="inputTag hidden" id="inputTagNguoikhongphe${index}">
							<input type="text" name="idNguoikhongphe${index}" class="classNguoikhongphe classFastMode"></div>
							<div class="w3-col s11"><label>Vấn đề còn tồn tại</label><textarea class="materialize-textarea" name="idNoidungkophe${index}"></textarea></div>
							<div class="w3-cell-row">
							<div class="w3-cell w3-center"><button class="w3-button ${btnStateColor} pheduyet" onclick="logF(dataConfirmTask,{elm:this,index:${index},state:0,source:'${source}'})" type="button">Xác nhận</button></div></div>
						</form>
						<form class="w3-row hidden" autocomplete="off">
							<div class="w3-col s8"><label>Người phê duyệt</label><input class="inputTag hidden" id="inputTagNguoipheduyet${index}">
							<input type="text" name="idNguoipheduyet${index}" class="classNguoipheduyet classFastMode"></div>
							<div class="w3-col s11"><label>Nội dung phê duyệt</label><textarea class="materialize-textarea" name="idNoidungphe${index}"></textarea></div>
							<div class="w3-cell-row">
							<div class="w3-cell w3-center"><button class="w3-button ${btnStateColor} pheduyet" onclick="logF(dataConfirmTask,{elm:this,index:${index},state:1,source:'${source}'})" type="button">Xác nhận</button></div></div>
						</form>
					</div></div>`;
					var tieptucBtns=
					`<div class="w3-cell-row nhanvienCtrl hidden">
						<div class="w3-cell w3-center"><button class="w3-button w3-theme w97 pheduyet" onclick="logF(dataResumeTask,{elm:this,index:${index},source:'${source}'});">Tiếp tục Công việc</button></div>
					</div>
					`;
					var stateExtend=(hoanthanhOk>0?(hoanthanhPheduyetOk>0?tieptucBtns:pheduyetBtns):
						(tamdungOk>0?(tamdungPheduyetOk>0?tieptucBtns:pheduyetBtns):hoanthanhBtns));

					// var elmDonvinhanTags = item.giaoviec.donvi.madonvi;
					var giaoviec = item.giaoviec;
					var elmEditForm = `<form class="w3-row hidden classEditForm" name="idGiaoviecForm${index}" id="idGiaoviecForm${index}" autocomplete="off">
								<div class="w3-col s12 m4 w3-container">
									<label for="idNguoigiao${index}">Người giao</label><input class="inputTag hidden" id="inputTagNguoigiao${index}" value='${JSON.stringify(giaoviec.nguoigiao)}'>
									<input type="text" name="idNguoigiao${index}" class="classNguoigiao">
								</div>
								<div class="w3-col s12 m4 w3-container">
									<label for="idPhutrach${index}">Người phụ trách</label><input class="inputTag hidden" id="inputTagPhutrach${index}" value='${JSON.stringify(giaoviec.chutri)}'>
									<input type="text" name="idPhutrach${index}" class="classPhutrach">
								</div>
								<div class="w3-col s12 m4 w3-container">
									<label for="idNguoinhan${index}">Người thực hiện</label><input class="inputTag hidden" id="inputTagNguoinhan${index}" value='${JSON.stringify(giaoviec.nguoinhan)}'>
									<input type="text" name="idNguoinhan${index}" class="classNguoinhan">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idDonvinhan${index}">Đơn vị thực hiện</label><input class="inputTag hidden" id="inputTagDonvinhan${index}" value='${JSON.stringify(giaoviec.donvi)}'>
									<input type="text" name="idDonvinhan${index}" class="classDonvinhan">
								</div>
								<div class="w3-col s8 w3-container">
									<label for="idDuan${index}">Thuộc dự án</label><input type="text" name="idDuan${index}" class="classDuan">
								</div>
								<div class="w3-col s8 m4 w3-container">
									<label for="idNgayYeucau${index}">Ngày yêu cầu hoàn thành</label><input type="date" name="idNgayYeucau${index}">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idTencongviec${index}">Tên công việc</label><input type="text" name="idTencongviec${index}">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idNoidungchitiet${index}">Nội dung chi tiết</label><textarea class="materialize-textarea" id="idNoidungchitiet${index}"></textarea>
								</div>
								<div class="w3-cell-row">
									<div class="w3-cell w3-center" ><button class="w3-button w3-green w97" type="button" onclick="logF(taskContentGetUI,{elm:this,index:${index}})">Xác nhận sửa</button></div>
								</div>
							</form>`;

					var elmMainContent = `<p class="pLR7px"><h4><b>Giao việc</b></h4></p>
								<p><b>Người giao: </b>${item.giaoviec.nguoigiao.hoten}</p>
								<p><b>Người phụ trách: </b>${item.giaoviec.chutri.hoten}</p>
								<p><b>Đơn vị thực hiện: </b>${item.giaoviec.donvi.ten}</p>
								<p><b>Người thực hiện: </b>${item.giaoviec.nguoinhan.hoten}</p>
								<p><b>Ngày giao việc: </b>${item.giaoviec.ngaygiao.full}</p>
								<p><b>Yêu cầu hoàn thành: </b>${item.giaoviec.thoihan.full}</p>
								${item.giaoviec.duan.length>0?`<p><b>Thuộc dựa án: </b>${item.giaoviec.duan}</p>`:''}
								<p><b>Nội dung chi tiết:</b></p>
								<p>${item.noidung.daydu.split('\n').join('</p><p>')}</p>`;

					
					getElmStateDetail=()=>{
						var tempStateDetail = '<p class="pLR7px"><h4><b>Tình trạng công việc (Báo cáo bổ sung)</b></h4></p>';
						try{
							var thuchienSubKeys=['hoten','hoten','full','noidung'], thuchienKeys=['nguoigui','nguoithuchien','ngaygui','tinhtrang']
							var splittedData=thuchienKeys.reduce((out,k,idx)=>{if(k!='ok') out[k]=item.thuchien[k][thuchienSubKeys[idx]].split('\n'); return out;},{});
							tempStateDetail+=splittedData.nguoigui.map((item,idx)=>
										`<h5><b>Ngày cập nhật: ${splittedData.ngaygui[idx]}</b></h5>
										<p><b>Người thực hiện: </b>${splittedData.nguoithuchien[idx]}</p>
										<p><b>Nội dung chi tiết: </b>${splittedData.tinhtrang[idx]}</p>`
							).join('<br>');	
						}catch(e){
							logE(null,e);
							tempStateDetail+=`<p><b>Người thực hiện: </b>${item.thuchien.nguoithuchien.hoten}</p>
									<p><b>Ngày cập nhật: </b>${item.thuchien.ngaygui.full}</p>
									<p><b>Nội dung chi tiết: </b></p>
									<p>${item.thuchien.tinhtrang.split('\n').join('</p><p>')}</p>`;
						}
						return tempStateDetail;
					}
					var elmStateDetail = thuchienOk?getElmStateDetail():'';

					var elmStateEditForm = `<form class="w3-row hidden" name="idStateEditForm${index}" id="idStateEditForm${index}" autocomplete="off">
								<input class="hidden" id="editFormLastData${index}" value='${JSON.stringify(item.thuchien)}'>
								<div class="w3-col s12 m6 l5 w3-container">
									<label for="idCapnhatNguoithuchien${index}">Người thực hiện</label>
									<input type="text" name="idCapnhatNguoithuchien${index}" class="classCapnhatNguoithuchien">
								</div>
								<div class="w3-col s12 w3-container">
									<label for="idTinhtrangCongviec${index}">Tình trạng công việc</label><input type="text" id="idTinhtrangCongviec${index}"></textarea>
								</div>
								<div class="w3-cell-row">
									<div class="w3-cell w3-center"><button class="w3-button w3-green w97" type="button" onclick="logF(dataUpdateStateTask,{elm:this,index:${index}})">Xác nhận sửa</button></div>
								</div>
							</form>`;

					var elmItem=`<li class="classMainListItem">
						<div class="pLR15px collapsible-header" >
							<div class="w3-cell-row">
								<div class="w3-cell m0px width70">
									<p><label><input type="checkbox"/><span></span></label><span class="pR4px txBlack">${item.noidung.tomtat}</span>${elmTags}</p>
								</div>
								<div class="w3-cell w3-cell-middle width15 txCenter"><p>${item.giaoviec.ngaygiao.short}</p></div>
								<div class="w3-cell w3-cell-middle width15 txLeft"><p><img src=${item.giaoviec.chutri.img?item.giaoviec.chutri.img:'"https://www.w3schools.com/w3css/img_avatar1.png"'} class="show400px w3-circle padAvatar width30">${item.giaoviec.chutri.ten}</p></div>
							</div>
						</div>
						<div class="pLR15px collapsible-body m0px">
							<div class="w3-cell-row">
								<div class="w3-cell w3-hide-medium w3-hide-large">
									${elmMainContent}
								</div>
								<div class="w3-cell width70 w3-hide-small">
									${elmMainContent}
								</div>
								<div class="w3-cell w3-cell-middle width15 w3-hide-small txCenter"><p>${item.giaoviec.thoihan.short}</p>
								</div>
								<div class="w3-cell w3-cell-middle width15 w3-hide-small txLeft"><p><img src=${item.giaoviec.nguoigiao.img?item.giaoviec.nguoigiao.img:'"https://www.w3schools.com/w3css/img_avatar1.png"'} class="show400px w3-circle padAvatar width30">${item.giaoviec.nguoigiao.ten}</p>
								</div>
							</div>
							<br>
							<div class="w3-cell-row bot10p">
								<div class="w3-cell w3-center hidden dulieuEditCtrl" ><button class="w3-button w3-green w97" type="button" onclick="logF(taskContentEditToggle,{elm:this,index:${index}})">Sửa nội dung Giao việc</button></div>
							</div>
							${elmEditForm}
							<hr>
							${elmStateDetail}
							<br>
							<div class="w3-cell-row bot10p">
								<div class="w3-cell w3-center dulieuEditCtrl" ><button class="w3-button w3-green w97" type="button" onclick="logF(taskStateEditToggle,{elm:this,index:${index}})">Bổ sung tình trạng công việc</button></div>
							</div> 
							${elmStateEditForm}
							<hr>
							<div class="w3-row fullw">${elmExtend}</div>
							${stateExtend}
						</div>
					</li>`;
					obDulieu.plus.insertAdjacentHTML('afterend',elmItem);
				}
				tagAnalysis=(item)=>{
					var tempTags={};
					if(item.tinhtrang.search(/Từ chối yêu cầu/gi)>-1) tempTags.stTuchoiYeucau="Từ chối yêu cầu";
					if(item.tinhtrang.search(/thực hiện/gi)>-1) tempTags.sthoanthanh="Đang thực hiện";
					if(item.tinhtrang.search(/hoàn thành/gi)>-1) tempTags.stHoanthanh="Hoàn thành";
					if(item.tinhtrang.search(/tạm dừng/gi)>-1) tempTags.stTamdung="Tạm dừng";
					if(tempTags.stHoanthanh&&item.tinhtrang.search(/chờ duyệt/gi)>-1) tempTags.stChoduyetHoanthanh="Chờ duyệt";
					if(tempTags.stTamdung&&item.tinhtrang.search(/chờ duyệt/gi)>-1) tempTags.stChoduyetTamdung="Chờ duyệt";

					if(tempTags.stHoanthanh!="Hoàn thành"){
						var fDue=item.giaoviec.thoihan.full.split('/'), deltaTime=new Date()-new Date(fDue[2],fDue[1]-1,parseInt(fDue[0])+1);
						if(deltaTime>0) tempTags.stQuahan="Quá hạn";
						if(item.giaoviec.thoihan.full==getToday()) tempTags.stHethan="Hết hạn hôm nay";
					}

					tempTags.stBatdau="Từ "+item.giaoviec.ngaygiao.short;
					if(item.giaoviec.thoihan.short.length>0) tempTags.stKetthuc="Đến "+item.giaoviec.thoihan.short;
					if(item.giaoviec.ngaygiao.full==getToday()) tempTags.stMoi="Mới";
					item.tempTags=tempTags; // bổ sung tempTags để lọc theo tags, các tags mới: Quá hạn/Hết hạn hôm nay/Mới sẽ ko có trong tình trạng
					return (Object.keys(tempTags).map((k)=>{return`<a class="w3-tag ${k} w3-round">${tempTags[k]}</a>`;})).join('<a class="pR4px">');
				}
				onInputTagAdded=(inpElm,arr,idx,params)=>{
					var staffId=mainData.staff.idxs[params.viewState][params.sectionKey][idx]; //[BGDKB][Donvinhan][0]
					var htmlTag=`<a class="pR4px"></a><div class="w3-tag sthoanthanh w3-round mb4p"><a class="${params.clName}TagActive" id="tagActive${staffId}">${arr[idx]}</a>
					<i class="ptr" onclick="this.parentElement.remove();">&times</i></div>`;
					inpElm.parentElement.children[0].insertAdjacentHTML('afterend',htmlTag);
					inpElm.value = '';
				}
				parseTagsForInput=()=>{
			  		var viewState=mainData.view.state=='NAOC'?'BGDKB':mainData.view.state;
					tagValueEachEditForm=(itemForm)=>{
						var formIndex=itemForm.id.replace('idGiaoviecForm','');
						tagValueEachInput=(sectionKey)=>{var inputOb=itemForm['inputTag'+sectionKey+formIndex];var savedOb=JSON.parse(inputOb.value),key=sectionKey=='Donvinhan'?'ten':'hoten';
							tagValueEachItem=(out,item,idx)=>{
								tagSearchForId=(out,itemName,idx)=>out==-1?(item==itemName?idx:-1):out;
								var nospaceItem = item.replace(' ','');
								if(item.length==0||nospaceItem.length==0) return out;

								var viewScope = viewState, nameList=mainData.staff.names;
								var dataIdx=nameList[viewScope][sectionKey].reduce(tagSearchForId,-1);

								if(dataIdx==-1) {
									tagMaAcvLookup=(key)=>obSidebar.data[1].c.reduce((lastIdx,nxtScope)=>(lastIdx==-1)?nameList[viewScope=nxtScope][key].reduce(tagSearchForId,-1):lastIdx,-1);
									dataIdx=tagMaAcvLookup(sectionKey);
									
									if(dataIdx==-1) {logE(null,'Lỗi, không tìm thấy người này trong danh sách: '+item);}
								}

								var staffId=mainData.staff.idxs[viewScope][sectionKey][dataIdx]; //[BGDKB][Donvinhan][0]
								var htmlTag=`<a class="pR4px"></a><div class="w3-tag sthoanthanh w3-round mb4p"><a class="class${sectionKey}TagActive" id="tagActive${staffId}">${item}</a><i class="ptr" onclick="this.parentElement.remove();">&times</i></div>`;	
								return htmlTag + out;
							}
							var tagList=savedOb[key].split(', ').reduce(tagValueEachItem,'');
							inputOb.insertAdjacentHTML('afterend',tagList);
						}
						['Nguoigiao','Phutrach','Nguoinhan','Donvinhan'].forEach(tagValueEachInput);
					}
					Array.from(obDulieu.list.getElementsByClassName('classEditForm')).forEach(tagValueEachEditForm);
				}

				dataFilter=(item, filter)=>{
					var giaoviec = item.giaoviec;
					analyzeSidebarSearchTerm=()=>{var gvChutri = giaoviec.chutri;switch(filter.sidebarSearchTerm){
						case 'NAOC': return true;
						case 'mygroup': 
							return gvChutri.madonvi.indexOf(mainData.user.madonvi)>-1||giaoviec.donvi.madonvi.indexOf(mainData.user.madonvi)>-1;
						case 'mine': return gvChutri.hoten==mainData.user.hoten || giaoviec.nguoinhan.hoten==mainData.user.hoten;
						case 'TBTTDD': case 'CDD': case 'BTSD': case 'MTKB': case'VPKB': case 'CHKNS':
							return gvChutri.madonvi.indexOf(filter.sidebarSearchTerm)>-1||giaoviec.donvi.madonvi.indexOf(filter.sidebarSearchTerm)>-1;
						case 'Duan': return giaoviec.duan==filter.sidebarSearchTx;
						default: return true;}}
					analyzeMainSearchTerm=(isolatedItem,lastResult)=>{var t=typeof isolatedItem;
						return (t=='string')?(lastResult||isolatedItem.search(filter.mainSearchTerm)>-1):(t=='array')? false:
						Object.keys(isolatedItem).reduce((last,k1)=>analyzeMainSearchTerm(isolatedItem[k1],last),lastResult);
					}
					return (analyzeSidebarSearchTerm()&&(filter.mainSearchTerm.length==0?true:analyzeMainSearchTerm(item,false)));
				}
			</script>

		</div>
	</div>

	<script description="UI standalone">
		itemStateSelected=(p)=>{
			var cont=p.elm.parentElement.parentElement.nextElementSibling;
			var contc=cont.classList,cont1c=cont.children[1].classList,cont0c=cont.children[0].classList;
			var lastState = contc.contains('hidden')?0:cont0c.contains('hidden')?3:2;
			var state = (lastState==p.state)?0:p.state,cList=[contc,cont0c,cont1c],sList=null;
			switch(state){
				case 0: sList=[true];break;case 2: sList=[false,false,true];break;case 3: sList=[false,true,false];break;
				default: alert('wrong item state'); throw 'wrong item state';
			}
			sList.map((s,sInd)=>{cList[sInd].toggle('hidden',s);});
		}
		taskContentEditToggle=(p)=>{p.elm=p.elm.parentElement.parentElement.nextElementSibling;p.elm.classList.toggle('hidden',p.force);logF(taskContentSetUI,p);}
		taskStateEditToggle=(p)=>{p.elm=p.elm.parentElement.parentElement.nextElementSibling;p.elm.classList.toggle('hidden',p.force);}
	</script>
	<script description="mainUI">
		var obMain={lastSolieuState:false}, obMainKeyList=['e','content','tieude','subSidebar','searchBar','solieu'];
		var obMainIdList=['idMain','idMainContainer','idMainTieude','idSubSidebar','idMainSearch','idMainSolieu'];
		initMainUI=()=>{initElm(obMain,obMainKeyList,obMainIdList);obMain.hideList=Array.from(obMain.solieu.getElementsByClassName('hideOnSearchFocus'))}

		mainElmsHideOnSmall=()=>{var scrWidth=obView.vw()-obSidebar.e.offsetWidth; var kList=['contents','subSidebars'];
			[300,900].map((w,wInd)=>{obMain[kList[wInd]].display=(scrWidth)<w?'none':'block'})}
		mainElmsUnhideOnSmall=()=>{['contents','subSidebars'].map((elm)=>{obMain[elm].display='block'})}

		isSolieuHideOnSmall=()=>obView.vw()-obMain.solieu.offsetWidth<100;
		mainSolieuHideOnSmall=()=>{if(isSolieuHideOnSmall()){tryLoop(obMain.hideList,elm=>elm.classList.toggle('hidden',obMain.lastSolieuState=true))}}
		mainSolieuUnhideOnSmall=()=>tryLoop(obMain.hideList,elm=>elm.classList.toggle('hidden',obMain.lastSolieuState=false))
		mainSolieuToggleOnSmall=()=>
		{if(isSolieuHideOnSmall()) 
			{tryLoop(obMain.hideList,elm=>elm.classList.toggle('hidden',!(obMain.lastSolieuState)));obMain.lastSolieuState=(!obMain.lastSolieuState);}}

		mainPopulateContent=(p)=>{setMainTitle(p);setMainList(p);setMainSolieu();}
		setMainTitle=(p)=>{obMain.tieude.children[0].innerHTML=obSidebar.data[p.g].i[p.i]};
		setMainList=(p)=>{
			var obSdp=obSidebar.data[p.g],mfc=mainData.filter;[mfc.sidebarSearchTerm,mfc.sidebarSearchTx]=[obSdp.c[p.i],obSdp.i[p.i]];
			getDonvi=(clickState)=>(clickState=='mine'||clickState=='mygroup')?mainData.user.madonvi:((clickState=='Duan')?'NAOC':clickState);
			mainData.view.state=getDonvi(obSdp.c[p.i]);
			if(uiReady) {logF(updateListDulieu);logF(uiSetPermission);}
		};
		setMainSolieu=()=>{if(uiReady){statisticLoading(mainData.congviecList);drawChart()}};//bug here When sidebarItem selected

		uiSetPermission=()=>{var maquyen=mainData.user.maquyen; uiAuthorizing(bitSelect(maquyen,3),bitSelect(maquyen,2),bitSelect(maquyen,1),bitSelect(maquyen,0));}
		uiAuthorizing=(addingRight,edittingRight,pheduyetRight,nhanvienRight)=>{
			obDulieu.plusc[addingRight==1?'remove':'add']("hidden");
			elmLoop(obDulieu.list,'dulieuEditCtrl',e=>e.classList[edittingRight==1?'remove':'add']('hidden'));
			elmLoop(obDulieu.list,'nhanvienCtrl',e=>e.classList[nhanvienRight==1?'remove':'add']('hidden'));
			elmLoop(obDulieu.list,'pheduyetCtrl',e=>e.classList[pheduyetRight==1?'remove':'add']('hidden'));
		}
		bitSelect=(input,challenge)=>((input>>challenge)&1);
		var lockMainSearch=false;
		mainSearch=(p)=>{ lockMainSearch=true;if((mainData.filter.mainSearchTerm=p.elm.value).length<10)
				setTimeout(()=>{sidebarItemClick(obSidebar.active);lockMainSearch=false},2000);else{sidebarItemClick(obSidebar.active);lockMainSearch=false;}}
		focusMainSearch=()=>mainSolieuHideOnSmall();
		
	</script>
	<script decsription="localStorage">
		checkLocalStorage=()=>(mainData.support.storage = (typeof(Storage)!='undefined'));
		localSet=(keyStr,objStr)=>localStorage.setItem(keyStr,objStr);
		localGet=(keyStr)=>localStorage.getItem(keyStr);
		localDel=(keyStr)=>{localStorage.removeItem(keyStr);}
		
	</script>
	<script description="dataProcess">
		dataToMem=()=>{
			if(mainData.support.storage){mainData.hash=localGet('hash');var t=localGet('congviecList');mainData.congviecList=JSON.parse(t?t:'[]');}

			var url=`${appscriptConfig.workUrl}?action=getList&email=${mainData.user.email}&uid=${mainData.user.uid}&hash=${mainData.hash}`;
		  	logE('getList:'+url);logF(overlayShowSpinner);
		  	callGasApi(url,true).then(gasApiCb).then(response=>{// merge data + main.user
		      logE('getList Ok:');
		      if(mainData.hash.length>0&&mainData.hash==response.hash){logE('already loaded content! - data OK'); logF(memToUi);logF(overlayHiddenAll);return;}

		      var values=mapJsonValue(response.header,decompressSheetValues(response.values));
		      mainData.hash=response.hash;logE('MainHash:'+mainData.hash);

		      (response.addOne==true)?mainData.congviecList.push(values[0]):mainData.congviecList=values; 
		      localSet('congviecList',JSON.stringify(mainData.congviecList));
		      localSet('hash',mainData.hash);
		      logE('AddOne:'+response.addOne);
		      logF(memToUi);logF(overlayHiddenAll);
		    },(er)=>alertEr('GasApiError+work',er));
		}
		
		memToUi=()=>{logE('sidebarAddGroup()');sidebarAddGroup(mainData.congviecList);logF(initAutoDuan);logF(loadStaffList);}

		loadStaffList=()=>{
			if(staffListReady) return;
			var url=`${appscriptConfig.userUrl}?action=getList`;
			logE('getList+user:'+url);
			callGasApi(url,true).then(gasApiCb).then(response=>{
				logE('getList User Ok:')
				staffListReady = true;
				mainData.staffList=mapJsonValue(response.header,decompressSheetValues(response.values));
				// mainData.staffAutoList=mainData.staffList.map(item=>item.hoten); //TODO: viet lai
				mainData.staff = staffGrouping(mainData.staffList);
				logF(initAutoStaffList);
			},er=>alertEr('GasApiError',er));
		}

		staffGrouping=(items)=>{
			var names={}, idxs={};
			items.forEach((item,idx)=>{
				var madonvi=item.madonvi, machucvu=item.machucvu, isBGDKB = madonvi=='BGDKB', isVPKB = madonvi=='VPKB', isBGDC = madonvi=='BGDC';
				if(isBGDC) return;
				if(!names[madonvi]) {names[madonvi]={};idxs[madonvi]={};}
				var shiftCode=(isBGDKB)?3:1, key=(isBGDKB)?'NAOC':madonvi, list=names[madonvi], listId=idxs[madonvi], canboCode=machucvu>>shiftCode;
				
				if(!list.Nguoigiao) {list.Nguoigiao=[]; listId.Nguoigiao=[];} 
				if(canboCode > 0) {list.Nguoigiao.push(item.hoten); listId.Nguoigiao.push(idx);}//can bo truong + pho
				['Nguoikhongphe','Nguoipheduyet'].forEach((key,keyIdx)=>{if(!list[key]){list[key]=list.Nguoigiao;listId[key]=listId.Nguoigiao;}});
				if(!list.Phutrach) {list.Phutrach=[]; listId.Phutrach=[];} 
				if(canboCode&1 > 0) {list.Phutrach.push(item.hoten); listId.Phutrach.push(idx);}//can bo pho

				// neu trong bgd: donvinhan-6doi,nguoinhan-6doi
				// neu trong VP: donvinhan-6doi,nguoinhan-vp
				// neu trong doi: donvinhan-doi,nguoinhan-nhanvien
				if(!(list.Donvinhan)) listId.Donvinhan=(list.Donvinhan=(isBGDKB||isVPKB)?obSidebar.origin[1].i:[item.donvi]).map((iged,igIdx)=>igIdx);
				
				if(!list.Nguoinhan) {list.Nguoinhan=[];listId.Nguoinhan=[];}
				['CapnhatNguoithuchien','Nguoihoanthanh','Nguoixintamdung'].forEach((key,keyIdx)=>{if(!list[key]){list[key]=list.Nguoinhan;listId[key]=listId.Nguoinhan;}});
				if(canboCode==0) {[list,names['BGDKB']].forEach(l=>l.Nguoinhan.push(item.hoten));[listId,idxs['BGDKB']].forEach(l=>l.Nguoinhan.push(idx));}
				
			});
			return {names:names,idxs:idxs};
		}
		
		backupSidebarData=()=>{obSidebar.origin=JSON.parse(JSON.stringify(obSidebar.data))}
		restoreSidebarData=()=>{obSidebar.data=JSON.parse(JSON.stringify(obSidebar.origin))}
		getInitSidebarData=()=>JSON.parse(JSON.stringify(obSidebar.initData));
		// sidebar add group
		duanGrouping=(items)=>items.reduce((out,item,idx)=>item.giaoviec.duan.length>0?(out[item.giaoviec.duan]=1)?out:out:out,{});
		adaptingGroup=(items)=>{var out={n:'Dự án',i:Object.keys(duanGrouping(items)),c:[]};out.i.forEach((g)=>{out.c.push('Duan');});return out};
		sidebarAddGroup=(cvList)=>{obSidebar.data=getInitSidebarData();
			obSidebar.data.push(logO(adaptingGroup(cvList)));
			logF(backupSidebarData);sidebarPopulateContent();sidebarItemClick(obSidebar.active)};

		
		taskContentGetUI=(p)=>{// get data from input //send to gas //add to mainData // update main ui mainData.congviecList.push(p);
			p.elm.disabled=true;
			var ext=p.index==-1?'':p.index, action=p.index==-1?'create':'edit', pos=p.index+3;
			var idElmList=['idNguoigiao','idPhutrach','idDonvinhan','idNguoinhan','idDuan','idNgayYeucau','idTencongviec','idNoidungchitiet'];
			const {vals,idxs}=macroTagActiveGetValues(idElmList,ext,p,4);

			var homnay=getToday(), thoihan=(vals[5].length>0)?formatFormDate(vals[5].split('-'),1):undefined;
			var queryData={id:{},
				giaoviec:{ngaygui:homnay,  // 04/10/2020
					nguoigui:{hoten:mainData.user.hoten,maAcv:mainData.user.maAcv},
					nguoigiao:idxs[0].length==0?getPersonJSON(vals[0]):getStaffJSON(idxs[0]),
					chutri:idxs[1].length==0?getPersonJSON(vals[1]):getStaffJSON(idxs[1]),donvi:idxs[2].length==0?getDonvinhanJSON(vals[2]):getDonvinhanListJSON(idxs[2]),//{ten:vals[2],madonvi:'TBTTDD'}
					nguoinhan:idxs[3].length==0?getPersonJSON(vals[3]):getStaffJSON(idxs[3]),
					duan:vals[4],thoihan:getDateJSON(thoihan)},tinhtrang:"Đang thực hiện",noidung:{tomtat:vals[6],daydu:vals[7]}};
			
			if(action=='create') queryData.giaoviec.ngaygiao = getDateJSON(homnay); // {full:'04/10/2020',short:'04/10'}

			var url=`${appscriptConfig.workUrl}?action=${action}&email=${mainData.user.email}&uid=${mainData.user.uid}&pos=${pos}&unit=${JSON.stringify(queryData)}`;
		  	logE(action+':'+url);
		  	callGasApi(url,true).then(gasApiCb).then(response=>{// merge data + main.user
		      switch(response.action) {
		      	case 'create': alert('Đã thêm công việc mới!');break;
		      	case 'edit': alert('Đã sửa công việc xong!');break;
		      	default: alert('Không xác định công việc, debug:'+JSON.stringify(response));
		      }
		      logF(dataToMem);
		      p.elm.disabled=false;
		      idElmList.forEach((k,idx)=>{p.elm.form[k+ext].value = ''; Array.from(p.elm.form.getElementsByClassName(k.replace('id','class')+'TagActive')).forEach(elm=>elm.parentElement.remove())});
		    },(er)=>{alertEr('GasApiError',er);p.elm.disabled=false;});
		}
		taskContentSetUI=(p)=>{
			var item=mainData.congviecList[p.index];
			const giaoviecSubkey=['hoten','hoten','hoten','full'], noidungKey=['tomtat','daydu'];
			var gv=['nguoigiao','chutri','nguoinhan','thoihan'].map((k,idx)=>
				{var v=item.giaoviec[k][giaoviecSubkey[idx]];return idx!=3?'':(v==undefined?v:formatFormDate(v.split('/'),'-'))});
			tryLoop(['idNguoigiao','idPhutrach','idNguoinhan','idNgayYeucau'],(k,idx)=>{p.elm[k+p.index].value=gv[idx]});
			tryLoop(['idTencongviec','idNoidungchitiet'],(k,idx)=>{p.elm[k+p.index].value=item.noidung[noidungKey[idx]]});
		}
		dataUpdateStateTask=(p)=>{
			p.elm.disabled=true;
			var pos=p.index+3,ext = p.index, idElmList=['idCapnhatNguoithuchien','idTinhtrangCongviec'];
			const {vals,idxs,hiddenValue}=macroTagActiveGetValues(idElmList,ext,p,1,'editFormLastData'+ext);
			var lastData = JSON.parse(hiddenValue), today = getTodayJSON();

			var queryData={
				thuchien:{ok:1, nguoigui:{hoten:appendLine(lastData.nguoigui.hoten,mainData.user.hoten),maAcv:appendLine(lastData.nguoigui.maAcv,mainData.user.maAcv)},
					ngaygui:{full:appendLine(lastData.ngaygui.full,today.full), short:appendLine(lastData.ngaygui.short,today.short)},
					nguoithuchien:idxs[0].length==0?getPersonJSON(vals[0],lastData.nguoithuchien):getStaffJSON(idxs[0],lastData.nguoithuchien),
					tinhtrang:{noidung:appendLine(lastData.tinhtrang.noidung,vals[1]) }}};
			
			var url=`${appscriptConfig.workUrl}?action=edit&email=${mainData.user.email}&uid=${mainData.user.uid}&pos=${pos}&unit=${JSON.stringify(queryData)}`;
		  	logE('edit:'+url);
		  	callGasApi(url,true).then(gasApiCb).then(response=>{// merge data + main.user
		      switch(response.action) {
		      	case 'edit': alert('Đã sửa công việc xong!');break;
		      	default: alert('Không xác định công việc, debug:'+JSON.stringify(response));
		      }
		      logF(dataToMem);
		      p.elm.disabled=false;
		      idElmList.forEach((k,idx)=>{p.elm.form[k+ext].value = ''; Array.from(p.elm.form.getElementsByClassName(k.replace('id','class')+'TagActive')).forEach(elm=>elm.parentElement.remove())});
		    },(er)=>{alertEr('GasApiError',er);p.elm.disabled=false;});
		}
		dataSubmitTask=(p)=>{
			var keySelect=p.state==0?['idNguoihoanthanh','idKetquahoanthanh']:['idNguoixintamdung','idLydotamdung'];
			const {vals,idxs}=macroTagActiveGetValues(keySelect,p.index,p,1);
			
			Array.from(document.getElementsByClassName('pheduyet')).forEach((submitBtn)=>{submitBtn.disabled=true});
			var hoanthanhData=()=>({hoanthanh:{ok:1,nguoigui:{hoten:mainData.user.hoten,maAcv:mainData.user.maAcv},ngayhoanthanh:getTodayJSON(),
				nguoihoanthanh:idxs[0].length==0?getPersonJSON(vals[0]):getStaffJSON(idxs[0]),
				ketqua:vals[1],pheduyet:{ok:0}},tinhtrang:'Hoàn thành, Chờ duyệt'})
			var tamdungData=()=>({tamdung:{ok:1,nguoigui:{hoten:mainData.user.hoten,maAcv:mainData.user.maAcv},ngayxintamdung:getTodayJSON(),
				nguoixintamdung:idxs[0].length==0?getPersonJSON(vals[0]):getStaffJSON(idxs[0]),
				lydo:vals[1],pheduyet:{ok:0}},tinhtrang:'Tạm dừng, Chờ duyệt'})
			var queryData=p.state==0?hoanthanhData():tamdungData();
			var pos = p.index+3;
			
			logE(queryData);
			var url=`${appscriptConfig.workUrl}?action=edit&email=${mainData.user.email}&uid=${mainData.user.uid}&pos=${pos}&unit=${JSON.stringify(queryData)}`;
		  	logE('Submit:'+url);
		  	callGasApi(url,true).then(gasApiCb).then(response=>{// merge data + main.user
		      switch(response.action) {
		      	case 'edit': alert('Đã báo cáo xong!');break;
		      	default: alert('Không xác định công việc, debug:'+JSON.stringify(response));
		      }
		      logF(dataToMem);
		    },(er)=>{alertEr('GasApiError',er);p.elm.disabled=false;});
		}
		dataConfirmTask=(p)=>{
			var keySelect=p.state==0?['idNguoikhongphe','idNoidungkophe']:['idNguoipheduyet','idNoidungphe'];
			const {vals,idxs}=macroTagActiveGetValues(keySelect,p.index,p,1);

			elmLoop(obDulieu.list,'pheduyet',submitBtn=>submitBtn.disabled=true);
			var pheduyetData={ok:(2-p.state),nguoigui:{hoten:mainData.user.hoten,maAcv:mainData.user.maAcv},
				ngaypheduyet:getTodayJSON(),nguoipheduyet:idxs[0].length==0?getPersonJSON(vals[0]):getStaffJSON(idxs[0]),noidung:vals[1]};
			var tinhtrang=(pheduyetData.ok==2?'Từ chối yêu cầu,':'')+(p.source=='hoanthanh'?'Hoàn thành':'Tạm dừng');
			var queryData={}; queryData[p.source]={pheduyet:pheduyetData}; queryData.tinhtrang=tinhtrang;
			var pos = p.index+3;

			logE(queryData);
			var url=`${appscriptConfig.workUrl}?action=edit&email=${mainData.user.email}&uid=${mainData.user.uid}&pos=${pos}&unit=${JSON.stringify(queryData)}`;
		  	logE('Confirm:'+url);
		  	callGasApi(url,true).then(gasApiCb).then(response=>{// merge data + main.user
		      switch(response.action) {
		      	case 'edit': alert('Đã phê duyệt xong!');break;
		      	default: alert('Không xác định công việc, debug:'+JSON.stringify(response));
		      }
		      logF(dataToMem);
		    },(er)=>{alertEr('GasApiError',er);p.elm.disabled=false;});
		}
		dataResumeTask=(p)=>{
			var hoanthanhData=()=>({tinhtrang:'Đang thực hiện',hoanthanh:{ok:'',nguoigui:{hoten:'',maAcv:''},ngayhoanthanh:getDateJSON(''),nguoihoanthanh:getPersonJSON(''),ketqua:''}})
			var tamdungData=()=>({tinhtrang:'Đang thực hiện',tamdung:{ok:'',nguoigui:{hoten:'',maAcv:''},ngayxintamdung:getDateJSON(''),nguoixintamdung:getPersonJSON(''),lydo:''}})
			var pheduyetData={ok:'',nguoigui:{hoten:'',maAcv:''},ngaypheduyet:getDateJSON(''),nguoipheduyet:getPersonJSON(''),noidung:''};
			var queryData=(p.source=='hoanthanh')?hoanthanhData():tamdungData();queryData[p.source].pheduyet=pheduyetData;
			var pos = p.index+3;

			elmLoop(obDulieu.list,'pheduyet',submitBtn=>submitBtn.disabled=true);
			var url=`${appscriptConfig.workUrl}?action=edit&email=${mainData.user.email}&uid=${mainData.user.uid}&pos=${pos}&unit=${JSON.stringify(queryData)}`;
		  	logE('Resume:'+url);
		  	callGasApi(url,true).then(gasApiCb).then(response=>{// merge data + main.user
		      switch(response.action) {
		      	case 'edit': alert('Đã báo tiếp tục công việc!');break;
		      	default: alert('Không xác định công việc, debug:'+JSON.stringify(response));
		      }
		      logF(dataToMem);
		    },(er)=>{alertEr('GasApiError',er);p.elm.disabled=false;});
		}


		macroTagActiveGetValues=(keyList,extKey,p, numOfSelectedIdxs,hiddenInputId)=>{var vals = [], idxs = [];
			keyList.forEach((k,idx)=>{var elm=p.elm.form[k+extKey];vals[idx]=p.elm.form[k+extKey].value;
				if(idx<numOfSelectedIdxs){
					var tempTagActive=Array.from(elm.parentElement.getElementsByClassName(k.replace('id','class')+'TagActive'));
					idxs[idx]=tempTagActive.map(elm=>(parseInt(elm.id.replace('tagActive',''))));
				}
			});
			return hiddenInputId?{vals:vals,idxs:idxs,hiddenValue:p.elm.form[hiddenInputId].value}:{vals:vals,idxs:idxs};
		}

	</script>
	<script description="dataPrototype">
		User=(p)=>{var thisOb=this;['hoten','email','maAcv','uid','rowIdx','chucdanh','donvi','maquyen'].forEach((k)=>{thisOb[k]=p[k]});}
		setMainDataUser=(user)=>{mainData.user=user}
		var mainData = {
			user:{},
			congviecList:[{
				id:{code:'',rowIdx:'',ten:''},
				noidung:{tomtat:'',daydu:''},
				tinhtrang: {code:2,tx:'Đang thực hiện'},
				tags:'Quá hạn,Hết hạn hôm nay,Từ 28/02',
				giaoviec:{
					ngaygiao:'',
					nguoigiao:{id:'',rowIdx:'',hoten:'',ten:'',email:'',chucdanh:'',donvi:'',img:''},
					chutri:{id:'',rowIdx:'',ten:'',email:'',chucdanh:'',donvi:''},
					thoihan:{full:'',short:''},
				},
				hoanthanh:{
					nguoihoanthanh:{id:'',rowIdx:'',hoten:'',ten:'',email:'',chucdanh:'',donvi:'',img:''},
					ketqua:'',
					ghichu:'',
				}
			}],
			filter:{sidebarSearchTerm:'',mainSearchTerm:''},
			settings:{fastMode:false},
			support:{storage:false},
			view:{state:'mine'}
		};
		testDulieu=()=>{
			var items=[{
				id:{code:'',rowIdx:''},
				noidung:{tomtat:'Bao tri he thong Trunking',daydu:'+ Kiem tra may tinh ghi am\n+ Kiểm tra tình trạng ghi âm\n+ Kiểm tra hệ thống tổng đài'},
				tinhtrang: 'Hoàn thành',
				tags:{stQuahan:'Quá hạn',stHoanthanh:'Hoàn thành',stKetthuc:'Hết hạn hôm nay',stBatdau:'Từ 28/02'},
				giaoviec:{
					ngaygiao:{short:'28/02',full:'28/02/2020'},
					nguoigiao:{id:'',rowIdx:'',hoten:'Tran Do Hai',ten:'Hai',email:'',chucdanh:'',donvi:'',img:''},
					chutri:{id:'',rowIdx:'',hoten:'Nguyen Thuong Hien',ten:'Hien',email:'',chucdanh:'',donvi:''},							
					thoihan:{full:'02/05/2020',short:'02/05'},
				},
				hoanthanh:{
					ngayhoanthanh:{short:'03/03',full:'03/03/2020'},
					nguoihoanthanh:{id:'',rowIdx:'',hoten:'Tran Quoc Hoan',ten:'Hoan',email:'',chucdanh:'',donvi:'',img:''},
					ketqua:'May tinh ghi am:OK\nTinh trang ghi am:OK\nHe thong tong dai:OK',
					pheduyet:{
						ngaypheduyet:{short:'03/03',full:'03/03/2020'},
						nguoipheduyet:{id:'',rowIdx:'',hoten:'Tran Do Hai',ten:'Hai',email:'',chucdanh:'',donvi:'',img:''},
						noidung:'OK'
					}
				},
			},{
				id:{code:'',rowIdx:'',ten:''},
				noidung:{tomtat:'Lap dat he thong canh bao nuoc muong ho',daydu:'+ Mua he thong\n+ Lap dat thu nghiem'},
				tinhtrang: 'Tạm dừng',
				tags:{stQuahan:'Quá hạn',stTamdung:'Tạm dừng',stKetthuc:'Hết hạn hôm nay',stBatdau:'Từ 28/02'},
				giaoviec:{
					ngaygiao:{short:'28/02',full:'28/02/2020'},
					nguoigiao:{id:'',rowIdx:'',hoten:'Tran Do Hai',ten:'Hai',email:'',chucdanh:'',donvi:'',img:''},
					chutri:{id:'',rowIdx:'',hoten:'Nguyen Manh Cuong',ten:'Cuong',email:'',chucdanh:'',donvi:''},							
					thoihan:{full:'02/06/2020',short:'02/06'},
				},
				tamdung:{
					ngayxintamdung:{short:'03/03',full:'03/03/2020'},
					nguoixintamdung:{id:'',rowIdx:'',hoten:'Nguyen Manh Cuong',ten:'Cuong',email:'',chucdanh:'',donvi:'',img:''},
					lydo:'Do dịch Covid-19, không thể nhập sensor về',
					pheduyet:{
						ngaypheduyet:{short:'03/03',full:'03/03/2020'},
						nguoipheduyet:{id:'',rowIdx:'',hoten:'Tran Do Hai',ten:'Hai',email:'',chucdanh:'',donvi:'',img:''},
						noidung:'Chập nhật tạm dừng'
					}
				},
			}
			];
			addListDulieu(items);
		}
	</script>
	<script description='viewControl'>
		var obDoc = {d:document,de:document.documentElement};
		var obView={vw:()=>Math.max(obDoc.de.clientWidth,window.innerWidth||0),vh:()=>Math.max(obDoc.de.clientHeight, window.innerHeight||0)}

		goToTop=()=>{document.body.scrollTop=0;/* For Safari*/document.documentElement.scrollTop=0;/*For Chrome, Firefox, IE and Opera*/};
		onScreenResize=()=>{sidebarResize(); mainSolieuUnhideOnSmall(); drawChart();}
	</script>

  <!-- Google Chart API -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

	<!-- Compiled and minified Material -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!-- GasAPI -->
  <script type="text/javascript">
		var appscriptConfig = {
		  userUrl:'https://script.google.com/macros/s/AKfycbxBeG7SIkZb5wR-vzTvBepIxgfD1WIkmK4SbHKFuMZs2F7AO_x7/exec',
		  workUrl:'https://script.google.com/macros/s/AKfycbyhFt7qXpE7XxOE5Elyk5tuHToHLyTo_lkoIJdP1haDXgq1_wM/exec',
		  // workUrl:'https://script.google.com/macros/s/AKfycby_LfQmKOnJncPl5ccreEOomj4O34Rl6-GH88RLbnobijv8YVc/exec'//Debug
		}
		callGasApi=(url,isJson)=>new Promise(dataCb=>{fetch(url).then(r=>(r.ok)?isJson?r.json():r.blob():alertEr(NetEr,'GasApi')).then(dataCb).catch(er=>alertEr(FetchEr,er));})
		gasApiCb=data=>new Promise((dataCb,errorCb)=>(data.status==false||data.message.error != undefined)?errorCb(data.message):dataCb(data.message))

		compressSheetValues=arrayInput=>JSON.stringify(arrayInput).replace(/,""/g,'~').replace(/,"/g,'`');
		decompressSheetValues=stringifyInput=>JSON.parse(stringifyInput.replace(/~/g,',""').replace(/`/g,',"'));

		dateShort=(inputDate)=>inputDate?inputDate.slice(0,inputDate.lastIndexOf('/')):'';
		formatDateForId=(date,delimiter)=>date?mergeStr(date.getFullYear())((1 + date.getMonth()).toString().padStart(2,'0'))(date.getDate().toString().padStart(2,'0'))(delimiter):undefined;
		formatFormDate=(formDateSplitted,delimiter)=>mergeStr(formDateSplitted[0])(formDateSplitted[1])(formDateSplitted[2])(delimiter);
		const mergeStr=y=>m=>d=>delimiter=>(delimiter == undefined)?(y + m + d):(typeof delimiter=='string')?d+delimiter+m+delimiter+y:d + '/' + m + '/' + y;

		getToday=()=>formatDateForId(new Date(),1);
		getTodayJSON=()=>getDateJSON(getToday());

		nameShort=(name)=>{var ns=name.split(' '); return (ns.length>1 && ns[0].search(/(Mr)||(Mrs)||(Ms)/i)>-1)?lastWord(name):name}
		lastWord=(word)=>word.slice(word.lastIndexOf(' ')+1);

		appendLine=(lastLine,nextLine)=>lastLine.length>0?lastLine+'\n'+nextLine:nextLine;

		lookForMadonvi=(tenDonvi)=>obSidebar.data[1].i.reduce((out,item,idx)=>(out==item)?obSidebar.data[1].c[idx]:out,tenDonvi);

		getDonvinhanListJSON=(donviIdxList)=>{
			if(donviIdxList.length==0) throw 'Id list is empty - Donvinhan';
			if(donviIdxList.length==1) return getDonvinhanJSON(null,donviIdxList[0]);
			var tenDonvi = '', maDonvi = '';
			donviIdxList.forEach((donviIdx,idx)=>{ tenDonvi+=((idx>0?', ':'')+obSidebar.data[1].i[donviIdx]); maDonvi+=((idx>0?', ':'')+obSidebar.data[1].c[donviIdx])});//PAUSE
			return{ten:tenDonvi,madonvi:maDonvi}
		}
		getDonvinhanJSON=(name,donviIdxIfExist)=>{
			var viewState = mainData.view.state;
			var tenDonvi = donviIdxIfExist>-1?(mainData.staff.names[viewState=='NAOC'?'BGDKB':viewState].Donvinhan[donviIdxIfExist]):name;
			var maDonvi = lookForMadonvi(tenDonvi);
			return {ten:tenDonvi,madonvi:maDonvi==tenDonvi?'--':maDonvi}
		}
		getStaffJSON=(staffIdxList, appendedOb)=>{
			if(staffIdxList.length==0) throw 'Id list is empty - Staff';
			var keyList=['hoten','ten','maAcv','madonvi'],tpOb={};// pause adding nameshort
			staffIdxList.forEach(staffId=>{var staffOb=mainData.staffList[staffId];keyList.forEach((k,idx)=>{tpOb[k]=tpOb[k]?tpOb[k]:[];tpOb[k].push(idx==1?nameShort(staffOb.hoten):staffOb[k])});});
			return keyList.reduce((out,k)=>{var tpOut=tpOb[k].join(', '); out[k]=appendedOb?(appendedOb[k]+'\n'+tpOut):tpOut; return out;},{});
		}
		getPersonJSON=(name,appendedOb)=>{
			var staffIdx = mainData.staffList.reduce((out,item,idx)=>(item.hoten==name)?idx:out,-1);
			var staffItem = staffIdx>-1?mainData.staffList[staffIdx]:{maAcv:'',madonvi:''};
			return appendedOb?{hoten:appendLine(appendedOb.hoten,name),ten:appendLine(appendedOb,nameShort(name)),maAcv:appendLine(appendedOb,staffItem.maAcv),madonvi:appendLine(appendedOb,staffItem.madonvi)}:
				{hoten:name,ten:nameShort(name),maAcv:staffItem.maAcv,madonvi:staffItem.madonvi};
		}
		getDateJSON=(dateSlashForm)=>dateSlashForm?{full:dateSlashForm,short:dateShort(dateSlashForm)}:{full:'',short:''}

		//function testMapJsonValue(){mapJsonValue(getJsonKey(),openSheet(workSj).getRange(3,1,1,10).getDisplayValues())}
		mapJsonValue=(header,values)=>values.map((r)=>r.reduce((l,o,oIdx)=>setValueJson(l,header[oIdx].split('.'),o),{}))
		//function testGetJsonKey(){getJsonKey()} - this is header - for gs only
		getJsonKey=()=>openSheet(workSj).getRange('2:2').getDisplayValues()[0];
		//function testSetValueJson(){var o={};setValueJson(o,['t','k','v'],'8');Logger.log(JSON.stringify(o))}
		setValueJson=(ob,keys,value)=>(keys.reduce((o,k,ki)=>k?(o[k]=(ki==keys.length-1)?((k.search(/ngay|thoihan/g)>-1)?{full:value,short:dateShort(value)}:value):(o[k]?o[k]:{})):o,ob)||true)?ob:'';
		
  </script>
  <!-- CustomScript -->
  <script src="lib/libScript.js"></script>
  <script src="lib/testScript.js"></script>
  
  <script src="lib/autocomplete-js.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/autocomplete-css.css">
  <script description="autocomplete">
  	initAutoStaffList=()=>{
  		logE('is staff list ready? => '+staffListReady);
  		if(!staffListReady) return;
  		var viewState=mainData.view.state=='NAOC'?'BGDKB':mainData.view.state, staffGr=mainData.staff.names[viewState];
  		Object.keys(staffGr).forEach((key,kIdx)=>tryLoop(['class'+key],(clForAuto)=>
  			elmLoop(document,clForAuto,e=>autocomplete(e,staffGr[key],onInputTagAdded,{clName:clForAuto,viewState:viewState,sectionKey:key}))));
  		logF(parseTagsForInput);
  	}
  	initAutoDuan=()=>{elmLoop(document,'classDuan',e=>autocomplete(e,obSidebar.origin[2].i));}
  </script>
  <script>
  	// description="Materialize Init"
	initScriptMaterialize=()=>{logF(initFab);M.Collapsible.init(document.querySelectorAll('.collapsible'), {});}
  	initScriptUI=()=>{logF(initMainUI);logF(initOverlay);logF(initSolieu);logF(initSideBar);logF(initDulieuUI);}
  	
  	var uiReady = false, staffListReady = false;
  	//Credit to:https://stackoverflow.com/questions/8835413/difference-between-load-vs-domcontentloaded
  	document.addEventListener("DOMContentLoaded", ()=>{
  		logF(checkLocalStorage);
  		logF(initFirebaseApp,{callback:()=>{logF(initScriptMaterialize);logF(initScriptUI);logF(dataToMem);uiReady=true;}});
  	});
  </script>
</body>
</html>